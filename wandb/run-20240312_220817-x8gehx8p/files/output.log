  | Name  | Type                         | Params
-------------------------------------------------------
0 | model | MoEViTForImageClassification | 5.3 M
-------------------------------------------------------
5.3 M     Trainable params
0         Non-trainable params
5.3 M     Total params
21.325    Total estimated model params size (MB)
/Users/fangyuanyu/anaconda3/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:441: The 'val_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=15` in the `DataLoader` to improve performance.
/Users/fangyuanyu/anaconda3/lib/python3.11/site-packages/lightning/pytorch/trainer/connectors/data_connector.py:441: The 'train_dataloader' does not have many workers which may be a bottleneck. Consider increasing the value of the `num_workers` argument` to `num_workers=15` in the `DataLoader` to improve performance.
/Users/fangyuanyu/anaconda3/lib/python3.11/site-packages/torch/autograd/__init__.py:251: UserWarning: The operator 'aten::sgn.out' is not currently supported on the MPS backend and will fall back to run on the CPU. This may have performance implications. (Triggered internally at /Users/runner/work/pytorch/pytorch/pytorch/aten/src/ATen/mps/MPSFallback.mm:13.)
  Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
Sanity Checking DataLoader 0:   0%|                                                                                                             | 0/2 [00:00<?, ?it/s]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Sanity Checking DataLoader 0:  50%|██████████████████████████████████████████████████▌                                                  | 1/2 [00:00<00:00,  1.99it/s]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   0%|                                                                                                                                | 0/391 [00:00<?, ?it/s]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   0%|▏                                                                             | 1/391 [00:01<07:46,  0.84it/s, v_num=hx8p, tl_step=5.150, ta_step=0.000]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   1%|▍                                                                            | 2/391 [00:01<05:52,  1.10it/s, v_num=hx8p, tl_step=5.130, ta_step=0.0156]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   1%|▌                                                                           | 3/391 [00:02<05:13,  1.24it/s, v_num=hx8p, tl_step=5.010, ta_step=0.00781]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 65, 4])                                                 | 4/391 [00:03<04:53,  1.32it/s, v_num=hx8p, tl_step=5.220, ta_step=0.000]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   1%|▉                                                                           | 5/391 [00:03<04:41,  1.37it/s, v_num=hx8p, tl_step=5.060, ta_step=0.00781]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   2%|█▏                                                                          | 6/391 [00:04<04:35,  1.40it/s, v_num=hx8p, tl_step=4.950, ta_step=0.00781]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Epoch 0:   2%|█▍                                                                           | 7/391 [00:04<04:28,  1.43it/s, v_num=hx8p, tl_step=4.870, ta_step=0.0156]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])                                                 | 4/391 [00:03<04:53,  1.32it/s, v_num=hx8p, tl_step=5.220, ta_step=0.000]Hidden states shape: torch.Size([128, 65, 128])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
/Users/fangyuanyu/anaconda3/lib/python3.11/site-packages/lightning/pytorch/trainer/call.py:54: Detected KeyboardInterrupt, attempting graceful shutdown...
Epoch 0:   2%|█▌                                                                           | 8/391 [00:05<04:23,  1.45it/s, v_num=hx8p, tl_step=4.930, ta_step=0.0234]Hidden states shape: torch.Size([128, 65, 128])
Gate scores shape: torch.Size([128, 65, 4])
Gate softmax shape: torch.Size([128, 65, 4])
Expert outputs shape: torch.Size([128, 65, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 65, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])
Expert outputs shape: torch.Size([128, 4, 4, 128])
Gate softmax unsqueezed shape: torch.Size([128, 4, 4, 1])
Output shape:  torch.Size([128, 4, 128])
Hidden states shape: torch.Size([128, 4, 128])
Gate scores shape: torch.Size([128, 4, 4])
Gate softmax shape: torch.Size([128, 4, 4])